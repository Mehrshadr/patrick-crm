generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Lead {
  id                 Int                 @id @default(autoincrement())
  name               String
  phone              String
  email              String?
  website            String?
  status             String              @default("New")
  stage              String              @default("New")
  call1Outcome       String?
  meeting1Outcome    String?
  meeting2Outcome    String?
  meeting3Outcome    String?
  auditStatus        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  nurtureStage       Int                 @default(0)
  nextNurtureAt      DateTime?
  quality            String?
  businessType       String?
  subStatus          String?
  nextMeetingAt      DateTime?
  automationStatus   String?
  meetingId          String?
  links              Link[]
  logs               Log[]
  notes              Note[]
  tasks              Task[]
  workflowExecutions WorkflowExecution[]
}

model Link {
  id        Int      @id @default(autoincrement())
  leadId    Int
  type      String
  title     String
  url       String
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Log {
  id        Int      @id @default(autoincrement())
  leadId    Int
  type      String
  stage     String?
  status    String
  title     String
  content   String
  meta      String?
  userEmail String?
  userName  String?
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Note {
  id        Int      @id @default(autoincrement())
  leadId    Int
  stage     String?
  content   String
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model MessageTemplate {
  id            Int            @id @default(autoincrement())
  name          String
  type          String
  scenario      String
  subject       String?
  body          String
  signature     String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  workflowSteps WorkflowStep[]
}

model Workflow {
  id                Int                 @id @default(autoincrement())
  name              String
  description       String?
  isActive          Boolean             @default(true)
  executionMode     String              @default("AUTO")
  pipelineStage     String?
  triggerType       String
  triggerStatus     String?
  triggerSubStatus  String?
  requireApproval   Boolean             @default(true)
  cancelOnStatus    String?
  cancelOnSubStatus String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  executions        WorkflowExecution[]
  steps             WorkflowStep[]
}

model WorkflowStep {
  id         Int              @id @default(autoincrement())
  workflowId Int
  name       String
  type       String
  order      Int
  config     String
  parentId   Int?
  templateId Int?
  template   MessageTemplate? @relation(fields: [templateId], references: [id])
  workflow   Workflow         @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

model WorkflowExecution {
  id            Int           @id @default(autoincrement())
  workflowId    Int
  leadId        Int
  status        String
  currentStepId Int?
  startDate     DateTime?
  scheduledFor  DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?
  cancelReason  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lead          Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  workflow      Workflow      @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  logs          WorkflowLog[]
}

model WorkflowLog {
  id          Int               @id @default(autoincrement())
  executionId Int
  stepId      Int?
  status      String
  message     String?
  createdAt   DateTime          @default(now())
  execution   WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
}

model AppSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model ActivityLog {
  id          Int              @id @default(autoincrement())
  category    String
  action      String
  entityType  String?
  entityId    Int?
  entityName  String?
  description String
  details     String?
  userId      String?
  userName    String?
  projectId   Int?
  createdAt   DateTime         @default(now())
  project     IndexingProject? @relation(fields: [projectId], references: [id])
}

model User {
  id                Int                @id @default(autoincrement())
  email             String             @unique
  name              String?
  role              String             @default("USER")
  patrickAccess     String             @default("HIDDEN")
  createdAt         DateTime           @default(now())
  lastLogin         DateTime?
  lastLoginIp       String?
  generatedContents GeneratedContent[]
  loginLogs         LoginLog[]
  projectAccess     ProjectAccess[]
  createdTasks      Task[]             @relation("TaskCreator")
}

model LoginLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  ip        String?
  userAgent String?
  success   Boolean  @default(true)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model IndexingProject {
  id                   Int                   @id @default(autoincrement())
  name                 String
  slug                 String?               @unique
  domain               String?
  description          String?
  sortOrder            Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  platform             String?
  activityLogs         ActivityLog[]
  discoveredPageTypes  DiscoveredPageType[]
  contents             GeneratedContent[]
  urls                 IndexingUrl[]
  jarvisConnections    JarvisConnection[]
  jarvisFlows          JarvisFlow[]
  linkBuildingKeywords LinkBuildingKeyword[]
  linkBuildingLogs     LinkBuildingLog[]
  assignedUsers        ProjectAccess[]
  settings             ProjectSettings?
  cachedPages          ProjectPage[]
}

model ProjectAccess {
  id        Int                @id @default(autoincrement())
  userId    Int
  projectId Int
  role      String             @default("MEMBER")
  createdAt DateTime           @default(now())
  project   IndexingProject    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  appAccess ProjectAppAccess[]

  @@unique([userId, projectId])
}

model IndexingUrl {
  id                   Int             @id @default(autoincrement())
  projectId            Int
  url                  String
  status               String          @default("PENDING")
  interval             String?
  lastSubmittedAt      DateTime?
  nextSubmitAt         DateTime?
  lastInspectionResult String?
  lastInspectedAt      DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  lastCrawledAt        DateTime?
  logs                 IndexingLog[]
  project              IndexingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, url])
}

model IndexingLog {
  id        Int         @id @default(autoincrement())
  urlId     Int
  action    String
  status    String
  response  String?
  createdAt DateTime    @default(now())
  userId    Int?
  userName  String?
  url       IndexingUrl @relation(fields: [urlId], references: [id], onDelete: Cascade)
}

model GoogleOAuthToken {
  id           Int      @id @default(autoincrement())
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  scope        String
  email        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model GoogleDocsToken {
  id           Int      @id @default(autoincrement())
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Task {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  dueDate     DateTime
  status      String    @default("PENDING")
  priority    String    @default("NORMAL")
  leadId      Int?
  createdById Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  createdBy   User?     @relation("TaskCreator", fields: [createdById], references: [id])
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model ContentGeneratorConfig {
  id          Int      @id @default(autoincrement())
  guidelines  String?
  aiRules     String?
  llmProvider String   @default("openai")
  llmModel    String   @default("gpt-4")
  updatedAt   DateTime @updatedAt
}

model ProjectSettings {
  id             Int             @id @default(autoincrement())
  projectId      Int             @unique
  brandStatement String?
  updatedAt      DateTime        @updatedAt
  cmsAppPassword String?
  cmsType        String?
  cmsUrl         String?
  cmsUsername    String?
  shopifyStore   String?
  shopifyToken   String?
  cmsApiKey      String?
  project        IndexingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectAppAccess {
  id        Int           @id @default(autoincrement())
  accessId  Int
  appType   String
  createdAt DateTime      @default(now())
  access    ProjectAccess @relation(fields: [accessId], references: [id], onDelete: Cascade)

  @@unique([accessId, appType])
}

model GeneratedContent {
  id            Int             @id @default(autoincrement())
  projectId     Int
  title         String?
  contentType   String
  brief         String
  content       String?
  status        String          @default("DRAFT")
  useGuidelines Boolean         @default(true)
  useAiRules    Boolean         @default(true)
  conversation  String?
  createdById   Int?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  llmPrompt     String?
  createdBy     User?           @relation(fields: [createdById], references: [id])
  project       IndexingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AnalyticsCounter {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Int      @default(0)
  updatedAt DateTime @updatedAt
}

model PatrickClick {
  id        Int      @id @default(autoincrement())
  clickedAt DateTime @default(now())
  hour      Int
  dayOfWeek Int
  date      String
}

model LinkBuildingKeyword {
  id           Int               @id @default(autoincrement())
  projectId    Int
  keyword      String
  targetUrl    String
  priority     Int               @default(0)
  isEnabled    Boolean           @default(true)
  pageTypes    String?
  onlyFirst    Boolean           @default(true)
  onlyFirstP   Boolean           @default(false)
  linksCreated Int               @default(0)
  lastRunAt    DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  project      IndexingProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  logs         LinkBuildingLog[]
}

model LinkBuildingLog {
  id          Int                 @id @default(autoincrement())
  projectId   Int
  keywordId   Int
  pageUrl     String
  pageTitle   String?
  anchorId    String?
  status      String
  message     String?
  createdAt   DateTime            @default(now())
  pageId      Int?
  linkedCount Int?
  redirectUrl String?
  keyword     LinkBuildingKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  project     IndexingProject     @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model DiscoveredPageType {
  id        Int             @id @default(autoincrement())
  projectId Int
  typeName  String
  count     Int             @default(0)
  project   IndexingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, typeName])
}

model JarvisConnection {
  id            Int             @id @default(autoincrement())
  projectId     Int
  connectorType String
  name          String
  icon          String?
  credentials   String
  config        String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  project       IndexingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model JarvisFlow {
  id          Int               @id @default(autoincrement())
  projectId   Int
  name        String
  description String?
  nodes       String
  edges       String
  isActive    Boolean           @default(true)
  webhookId   String?           @unique
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  executions  JarvisExecution[]
  project     IndexingProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model JarvisExecution {
  id          Int         @id @default(autoincrement())
  flowId      Int
  status      String      @default("running")
  triggerType String?
  triggerData String?
  startedAt   DateTime    @default(now())
  finishedAt  DateTime?
  flow        JarvisFlow  @relation(fields: [flowId], references: [id], onDelete: Cascade)
  logs        JarvisLog[]
}

model JarvisLog {
  id          Int             @id @default(autoincrement())
  executionId Int
  nodeId      String
  nodeName    String
  nodeType    String
  status      String
  input       String?
  output      String?
  error       String?
  duration    Int?
  timestamp   DateTime        @default(now())
  execution   JarvisExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
}

model ProjectPage {
  id             Int             @id @default(autoincrement())
  projectId      Int
  cmsId          String          // Original ID from CMS (e.g. WP post ID)
  url            String
  title          String?
  content        String?         @db.Text // Cached content for keyword scanning
  pageType       String?         // post, page, product, etc.
  hasRedirect    Boolean         @default(false)
  redirectUrl    String?
  lastSyncedAt   DateTime        @default(now())
  lastModifiedAt DateTime?       // Remote modification time for incremental sync
  
  project        IndexingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, cmsId]) // Prevent duplicate pages per project (by CMS ID)
  @@index([projectId, url])
}
